# CIツール定期ビルド＆キャッシュ更新 Workflow
#
# attic CLIとdeploy-rsをビルドしてAtticキャッシュにpushする。
# 他リポジトリのCIはキャッシュからプリビルド済みバイナリを取得できる。

name: Update CI Tools Cache

on:
  push:
    paths:
      - 'flake.nix'
      - 'flake.lock'
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  build-and-cache:
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            system: x86_64-linux
          - runner: macos-latest
            system: aarch64-darwin
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://cache.shinbunbun.com/main
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= main:EMoov6FniyxjYhY24OcZ02dOIWKu4feJH7uGRjgwwUc=
            netrc-file = /etc/nix/netrc
            fallback = true
            connect-timeout = 5

      - name: Setup Attic authentication
        run: |
          echo "machine cache.shinbunbun.com password ${{ secrets.ATTIC_TOKEN }}" | sudo tee /etc/nix/netrc > /dev/null
          sudo chmod 600 /etc/nix/netrc

      - name: Build attic
        run: |
          nix build ".#packages.${{ matrix.system }}.attic" \
            --print-build-logs \
            --out-link result-attic

      - name: Build deploy-rs
        run: |
          nix build ".#packages.${{ matrix.system }}.deploy-rs" \
            --print-build-logs \
            --out-link result-deploy-rs

      - name: Push to Attic cache
        run: |
          ./result-attic/bin/attic login ci https://cache.shinbunbun.com ${{ secrets.ATTIC_TOKEN }}
          ./result-attic/bin/attic cache create main || echo "Cache already exists"

          echo "Pushing attic to cache..."
          ./result-attic/bin/attic push -j 3 main result-attic || echo "Failed to push attic (non-fatal)"

          echo "Pushing deploy-rs to cache..."
          ./result-attic/bin/attic push -j 3 main result-deploy-rs || echo "Failed to push deploy-rs (non-fatal)"
        continue-on-error: true
