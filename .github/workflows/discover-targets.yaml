# Flakeターゲット自動検出 Reusable Workflow
#
# nix eval でflakeのNixOS/Darwin設定名とパッケージリストを動的に検出する。
# 検出結果はoutputsとしてmatrix strategyに渡せる。
#
# 使用方法:
#   uses: shinbunbun/nix-ci-workflows/.github/workflows/discover-targets.yaml@main
#
# outputs (全てmatrix strategy用JSON):
#   nixos-matrix:           '{"configuration":["homeMachine"]}'
#   darwin-matrix:          '{"configuration":["mx-macbook"]}'
#   linux-packages-matrix:  '{"package":["attic","deploy-rs"]}'
#   darwin-packages-matrix: '{"package":["attic"]}'
#   has-nixos / has-darwin / has-linux-packages / has-darwin-packages: 'true' / 'false'

name: Discover Flake Targets

on:
  workflow_call:
    inputs:
      runner:
        description: 'GitHub Actions runner'
        type: string
        default: 'ubuntu-latest'
      skip-nix-install:
        description: 'Skip Nix installation (for self-hosted NixOS runners)'
        type: boolean
        default: false
    outputs:
      nixos-matrix:
        description: 'NixOS configurations matrix JSON'
        value: ${{ jobs.discover.outputs.nixos-matrix }}
      darwin-matrix:
        description: 'Darwin configurations matrix JSON'
        value: ${{ jobs.discover.outputs.darwin-matrix }}
      linux-packages-matrix:
        description: 'Linux packages matrix JSON'
        value: ${{ jobs.discover.outputs.linux-packages-matrix }}
      darwin-packages-matrix:
        description: 'Darwin packages matrix JSON'
        value: ${{ jobs.discover.outputs.darwin-packages-matrix }}
      has-nixos:
        description: 'Whether NixOS configurations exist'
        value: ${{ jobs.discover.outputs.has-nixos }}
      has-darwin:
        description: 'Whether Darwin configurations exist'
        value: ${{ jobs.discover.outputs.has-darwin }}
      has-linux-packages:
        description: 'Whether Linux packages exist'
        value: ${{ jobs.discover.outputs.has-linux-packages }}
      has-darwin-packages:
        description: 'Whether Darwin packages exist'
        value: ${{ jobs.discover.outputs.has-darwin-packages }}

jobs:
  discover:
    runs-on: ${{ startsWith(inputs.runner, '[') && fromJSON(inputs.runner) || inputs.runner }}
    outputs:
      nixos-matrix: ${{ steps.detect.outputs.nixos-matrix }}
      darwin-matrix: ${{ steps.detect.outputs.darwin-matrix }}
      linux-packages-matrix: ${{ steps.detect.outputs.linux-packages-matrix }}
      darwin-packages-matrix: ${{ steps.detect.outputs.darwin-packages-matrix }}
      has-nixos: ${{ steps.detect.outputs.has-nixos }}
      has-darwin: ${{ steps.detect.outputs.has-darwin }}
      has-linux-packages: ${{ steps.detect.outputs.has-linux-packages }}
      has-darwin-packages: ${{ steps.detect.outputs.has-darwin-packages }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix with flakes enabled
        if: ${{ !inputs.skip-nix-install }}
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Detect flake targets
        id: detect
        run: |
          # NixOS / Darwin 設定名を検出
          NIXOS=$(nix eval --json .#nixosConfigurations --apply builtins.attrNames 2>/dev/null || echo '[]')
          DARWIN=$(nix eval --json .#darwinConfigurations --apply builtins.attrNames 2>/dev/null || echo '[]')

          # パッケージ検出（nix evalはビルドせずキー名のみ取得）
          LINUX_PKGS=$(nix eval --json '.#packages.x86_64-linux' --apply builtins.attrNames 2>/dev/null || echo '[]')
          DARWIN_PKGS=$(nix eval --json '.#packages.aarch64-darwin' --apply builtins.attrNames 2>/dev/null || echo '[]')

          # matrix用JSONを生成
          echo "nixos-matrix={\"configuration\":$NIXOS}" >> "$GITHUB_OUTPUT"
          echo "darwin-matrix={\"configuration\":$DARWIN}" >> "$GITHUB_OUTPUT"
          echo "linux-packages-matrix={\"package\":$LINUX_PKGS}" >> "$GITHUB_OUTPUT"
          echo "darwin-packages-matrix={\"package\":$DARWIN_PKGS}" >> "$GITHUB_OUTPUT"

          # 空配列チェック
          NIXOS_COUNT=$(echo "$NIXOS" | jq 'length')
          DARWIN_COUNT=$(echo "$DARWIN" | jq 'length')
          LINUX_PKGS_COUNT=$(echo "$LINUX_PKGS" | jq 'length')
          DARWIN_PKGS_COUNT=$(echo "$DARWIN_PKGS" | jq 'length')

          echo "has-nixos=$( [ "$NIXOS_COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          echo "has-darwin=$( [ "$DARWIN_COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          echo "has-linux-packages=$( [ "$LINUX_PKGS_COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          echo "has-darwin-packages=$( [ "$DARWIN_PKGS_COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"

          # デバッグ出力
          echo "NixOS configurations: $NIXOS"
          echo "Darwin configurations: $DARWIN"
          echo "Linux packages: $LINUX_PKGS"
          echo "Darwin packages: $DARWIN_PKGS"
