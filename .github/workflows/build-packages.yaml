# パッケージ一括ビルド用 Reusable Workflow
#
# 指定されたパッケージリストを順次ビルドし、Atticキャッシュにプッシュする。
# WireGuard VPN接続はオプション（needs-wireguard で制御）。
# Atticキャッシュ連携はオプション（use-attic で制御）。
#
# 使用方法:
#   uses: shinbunbun/nix-ci-workflows/.github/workflows/build-packages.yaml@main
#   with:
#     runner: ubuntu-latest
#     system: x86_64-linux
#     packages: '["attic","deploy-rs"]'

name: Build Packages

on:
  workflow_call:
    inputs:
      runner:
        description: 'GitHub Actions runner (e.g. ubuntu-latest, macos-latest)'
        required: true
        type: string
      system:
        description: 'Nix system (e.g. x86_64-linux, aarch64-darwin)'
        required: true
        type: string
      packages:
        description: 'JSON array of package names to build'
        required: true
        type: string
      needs-wireguard:
        description: 'Whether WireGuard VPN is needed for Attic access'
        required: false
        type: boolean
        default: false
      use-attic:
        description: 'Whether to use Attic binary cache (substituter + push)'
        required: false
        type: boolean
        default: true
      push-to-cache:
        description: 'Whether to push build results to Attic cache'
        required: false
        type: boolean
        default: true
      attic-server:
        description: 'Attic server URL for push'
        required: false
        type: string
        default: 'https://cache.shinbunbun.com'
    secrets:
      AUTHENTIK_CLIENT_ID:
        required: false
      ATTIC_TOKEN:
        required: false
      ATTIC_READ_TOKEN:
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup WireGuard VPN
        if: inputs.needs-wireguard
        uses: shinbunbun/nix-ci-workflows/.github/actions/wireguard@main
        with:
          authentik-client-id: ${{ secrets.AUTHENTIK_CLIENT_ID }}

      - name: Install Nix with flakes enabled (with Attic)
        if: inputs.use-attic
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://cache.shinbunbun.com/main
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= main:EMoov6FniyxjYhY24OcZ02dOIWKu4feJH7uGRjgwwUc=
            netrc-file = /etc/nix/netrc
            fallback = true
            connect-timeout = 5

      - name: Install Nix with flakes enabled (without Attic)
        if: ${{ !inputs.use-attic }}
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Attic authentication
        if: inputs.use-attic
        run: |
          TOKEN="${{ secrets.ATTIC_READ_TOKEN }}"
          if [[ -z "$TOKEN" ]]; then
            TOKEN="${{ secrets.ATTIC_TOKEN }}"
          fi
          if [[ -n "$TOKEN" ]]; then
            echo "machine cache.shinbunbun.com password $TOKEN" | sudo tee /etc/nix/netrc > /dev/null
            sudo chmod 600 /etc/nix/netrc
          fi

      - name: Build all packages
        run: |
          for pkg in $(echo '${{ inputs.packages }}' | jq -r '.[]'); do
            echo "::group::Building package: $pkg"
            nix build ".#packages.${{ inputs.system }}.$pkg" \
              --print-build-logs \
              --show-trace \
              --out-link "result-pkg-$pkg"
            echo "::endgroup::"
          done

      - name: Configure and push to Attic cache
        if: inputs.use-attic && inputs.push-to-cache && github.event_name == 'push'
        run: |
          # atticがビルド対象に含まれていればローカルビルド済みのものを使用
          if [[ -L "result-pkg-attic" ]]; then
            ATTIC_CLI="./result-pkg-attic/bin/attic"
          else
            nix build .#attic --out-link attic-cli 2>/dev/null || \
              nix build ".#packages.${{ inputs.system }}.attic" --out-link attic-cli 2>/dev/null || true
            if [[ -L "attic-cli" ]]; then
              ATTIC_CLI="./attic-cli/bin/attic"
            else
              echo "Attic CLI not available, skipping cache push"
              exit 0
            fi
          fi

          $ATTIC_CLI login ci "${{ inputs.attic-server }}" ${{ secrets.ATTIC_TOKEN }}
          $ATTIC_CLI cache create main || echo "Cache already exists"

          # 全パッケージをキャッシュにプッシュ
          for link in result-pkg-*; do
            if [[ -L "$link" ]]; then
              echo "Pushing $link to cache..."
              $ATTIC_CLI push -j 3 main "$link" || echo "Failed to push $link (non-fatal)"
            fi
          done
        continue-on-error: true
