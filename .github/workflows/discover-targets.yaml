# Flakeターゲット自動検出 Reusable Workflow
#
# nix eval でflakeのNixOS/Darwin設定名とパッケージリストを動的に検出する。
# 検出結果はoutputsとしてmatrix strategyやbuild-packages等に渡せる。
#
# 使用方法:
#   uses: shinbunbun/nix-ci-workflows/.github/workflows/discover-targets.yaml@main
#
# outputs:
#   nixos-matrix:       '{"configuration":["homeMachine"]}' (matrix用JSON)
#   darwin-matrix:      '{"configuration":["mx-macbook"]}' (matrix用JSON)
#   has-nixos:          'true' / 'false'
#   has-darwin:         'true' / 'false'
#   linux-packages:     '["attic","deploy-rs"]' (JSON配列)
#   darwin-packages:    '["attic"]' (JSON配列)
#   has-linux-packages: 'true' / 'false'
#   has-darwin-packages:'true' / 'false'

name: Discover Flake Targets

on:
  workflow_call:
    inputs:
      runner:
        description: 'GitHub Actions runner'
        type: string
        default: 'ubuntu-latest'
    outputs:
      nixos-matrix:
        description: 'NixOS configurations matrix JSON'
        value: ${{ jobs.discover.outputs.nixos-matrix }}
      darwin-matrix:
        description: 'Darwin configurations matrix JSON'
        value: ${{ jobs.discover.outputs.darwin-matrix }}
      has-nixos:
        description: 'Whether NixOS configurations exist'
        value: ${{ jobs.discover.outputs.has-nixos }}
      has-darwin:
        description: 'Whether Darwin configurations exist'
        value: ${{ jobs.discover.outputs.has-darwin }}
      linux-packages:
        description: 'Linux packages JSON array'
        value: ${{ jobs.discover.outputs.linux-packages }}
      darwin-packages:
        description: 'Darwin packages JSON array'
        value: ${{ jobs.discover.outputs.darwin-packages }}
      has-linux-packages:
        description: 'Whether Linux packages exist'
        value: ${{ jobs.discover.outputs.has-linux-packages }}
      has-darwin-packages:
        description: 'Whether Darwin packages exist'
        value: ${{ jobs.discover.outputs.has-darwin-packages }}

jobs:
  discover:
    runs-on: ${{ inputs.runner }}
    outputs:
      nixos-matrix: ${{ steps.detect.outputs.nixos-matrix }}
      darwin-matrix: ${{ steps.detect.outputs.darwin-matrix }}
      has-nixos: ${{ steps.detect.outputs.has-nixos }}
      has-darwin: ${{ steps.detect.outputs.has-darwin }}
      linux-packages: ${{ steps.detect.outputs.linux-packages }}
      darwin-packages: ${{ steps.detect.outputs.darwin-packages }}
      has-linux-packages: ${{ steps.detect.outputs.has-linux-packages }}
      has-darwin-packages: ${{ steps.detect.outputs.has-darwin-packages }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Detect flake targets
        id: detect
        run: |
          # NixOS / Darwin 設定名を検出
          NIXOS=$(nix eval --json .#nixosConfigurations --apply builtins.attrNames 2>/dev/null || echo '[]')
          DARWIN=$(nix eval --json .#darwinConfigurations --apply builtins.attrNames 2>/dev/null || echo '[]')

          # パッケージ検出（nix evalはビルドせずキー名のみ取得）
          LINUX_PKGS=$(nix eval --json '.#packages.x86_64-linux' --apply builtins.attrNames 2>/dev/null || echo '[]')
          DARWIN_PKGS=$(nix eval --json '.#packages.aarch64-darwin' --apply builtins.attrNames 2>/dev/null || echo '[]')

          # matrix用JSONを生成
          echo "nixos-matrix={\"configuration\":$NIXOS}" >> "$GITHUB_OUTPUT"
          echo "darwin-matrix={\"configuration\":$DARWIN}" >> "$GITHUB_OUTPUT"

          # 空配列チェック
          NIXOS_COUNT=$(echo "$NIXOS" | jq 'length')
          DARWIN_COUNT=$(echo "$DARWIN" | jq 'length')
          LINUX_PKGS_COUNT=$(echo "$LINUX_PKGS" | jq 'length')
          DARWIN_PKGS_COUNT=$(echo "$DARWIN_PKGS" | jq 'length')

          echo "has-nixos=$( [ "$NIXOS_COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          echo "has-darwin=$( [ "$DARWIN_COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          echo "has-linux-packages=$( [ "$LINUX_PKGS_COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          echo "has-darwin-packages=$( [ "$DARWIN_PKGS_COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"

          echo "linux-packages=$LINUX_PKGS" >> "$GITHUB_OUTPUT"
          echo "darwin-packages=$DARWIN_PKGS" >> "$GITHUB_OUTPUT"

          # デバッグ出力
          echo "NixOS configurations: $NIXOS"
          echo "Darwin configurations: $DARWIN"
          echo "Linux packages: $LINUX_PKGS"
          echo "Darwin packages: $DARWIN_PKGS"
